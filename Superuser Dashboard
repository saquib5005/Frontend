import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { Router } from '@angular/router';
import { InputText } from 'primeng/inputtext';
import { Button } from 'primeng/button';
import { Select } from 'primeng/select';
import { ApiService } from '../../../core/services/api';
import { AuthService } from '../../auth/auth.service';

@Component({
  selector: 'app-create-policy',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, InputText, Button, Select],
  templateUrl: './create-policy.html',
  styleUrl: './create-policy.scss'
})
export class CreatePolicyComponent {
  policyForm: FormGroup;
  
  planTypes = [
    { label: 'Health Insurance', value: 'Health Insurance' },
    { label: 'Life Insurance', value: 'Life Insurance' },
    { label: 'Motor Insurance', value: 'Motor Insurance' },
    { label: 'Property Insurance', value: 'Property Insurance' }
  ];

  constructor(
    private fb: FormBuilder, 
    private apiService: ApiService, 
    private authService: AuthService,
    private router: Router
  ) {
    // REMOVED policyId from the form group
    this.policyForm = this.fb.group({
      name: ['', Validators.required],
      planType: ['', Validators.required],
      premium: [null, [Validators.required, Validators.min(1)]],
      coverage: [null, [Validators.required, Validators.min(1)]]
    });
  }

  onCreate() {
    if (this.policyForm.valid) {
      const superUserId = this.authService.getUserId();
      const formValues = this.policyForm.value;

      // Construct the payload matching your Spring Boot 'Plan' entity
      // We do NOT send policyId; the database will generate it.
      const payload = {
        planName: formValues.name,
        planType: formValues.planType,
        monthlyPremium: Number(formValues.premium), // Force number type
        coverageLimit: Number(formValues.coverage)  // Force number type
      };

      console.log('Sending Payload to /api/plans/create:', payload);

      this.apiService.createPolicy(payload, superUserId).subscribe({
        next: (response) => {
          alert('Policy successfully published to the database!');
          this.policyForm.reset();
          this.router.navigate(['/dashboard/super-policies']); 
        },
        error: (err) => {
          console.error('Failed to create policy:', err);
          alert('Failed to save policy. Check your Spring Boot console.');
        }
      });
    } else {
      this.policyForm.markAllAsTouched();
    }
  }
}

---------
<div class="card-container" style="padding: 2rem; max-width: 600px; margin: 0 auto;">
  <h2 style="color: #00915a; margin-bottom: 0.5rem;">Create New Policy</h2>
  <p style="color: #666; margin-bottom: 2rem;">Define a new insurance plan for users.</p>

  <form [formGroup]="policyForm" (ngSubmit)="onCreate()" class="p-fluid" style="display: flex; flex-direction: column; gap: 1.5rem;">
    
    <div class="field">
      <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Plan Name</label>
      <input pInputText formControlName="name" placeholder="e.g. Premium Health Shield" />
      <small class="p-error" *ngIf="policyForm.get('name')?.invalid && policyForm.get('name')?.touched" style="color: red;">Plan name is required.</small>
    </div>

    <div class="field">
      <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Plan Type</label>
      <p-select formControlName="planType" [options]="planTypes" placeholder="Select Type" styleClass="w-full"></p-select>
      <small class="p-error" *ngIf="policyForm.get('planType')?.invalid && policyForm.get('planType')?.touched" style="color: red;">Plan type is required.</small>
    </div>

    <div class="field">
      <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Monthly Premium ($)</label>
      <input pInputText type="number" formControlName="premium" placeholder="e.g. 150" />
      <small class="p-error" *ngIf="policyForm.get('premium')?.invalid && policyForm.get('premium')?.touched" style="color: red;">Valid premium amount is required.</small>
    </div>

    <div class="field">
      <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Coverage Limit ($)</label>
      <input pInputText type="number" formControlName="coverage" placeholder="e.g. 50000" />
      <small class="p-error" *ngIf="policyForm.get('coverage')?.invalid && policyForm.get('coverage')?.touched" style="color: red;">Valid coverage amount is required.</small>
    </div>

    <p-button label="Publish Policy" type="submit" styleClass="p-button-success w-full" [disabled]="policyForm.invalid"></p-button>

  </form>
</div>


=========================

// 1. Create Policy (remains the same)
  createPolicy(policyData: any, userId: string): Observable<any> {
    const headers = new HttpHeaders().set('userId', userId);
    return this.http.post(`${this.baseUrl}/plans/create`, policyData, { headers: headers, responseType: 'text' });
  }

  // 2. UPDATED: View All Policies
  // Now fetching from /api/plans to see ALL data (old + new)
  getSuperCreatedPolicies(userId: string): Observable<any> {
    const headers = new HttpHeaders().set('userId', userId);
    return this.http.get(`${this.baseUrl}/plans`, { headers: headers });
  }

=====================

import { Component, OnInit, ChangeDetectorRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TableModule } from 'primeng/table';
import { Tag } from 'primeng/tag';
import { ApiService } from '../../../core/services/api';
import { AuthService } from '../../auth/auth.service';

@Component({
  selector: 'app-super-policies',
  standalone: true,
  imports: [CommonModule, TableModule, Tag],
  template: `
    <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
      <h2 style="margin-top: 0; color: #00915a;">All Created Policies</h2>
      <p style="color: #666; margin-bottom: 2rem;">A master list of all policies currently in the database.</p>

      <p-table [value]="policies" styleClass="p-datatable-striped" [tableStyle]="{'min-width': '50rem'}">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Plan Name</th>
            <th>Type</th>
            <th>Monthly Premium</th>
            <th>Coverage Limit</th>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-policy>
          <tr>
            <td style="font-weight: bold;">{{ policy.planId || policy.policyId || policy.id }}</td>
            <td>{{ policy.planName || policy.name }}</td>
            <td>
              <p-tag [value]="policy.planType || policy.type" severity="info"></p-tag>
            </td>
            <td>{{ policy.monthlyPremium || policy.premium | currency:'USD' }}</td>
            <td>{{ policy.coverageLimit || policy.coverage | currency:'USD' }}</td>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem;">
              No policies found. Go to 'Create Policy' to add one!
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  `
})
export class SuperPoliciesComponent implements OnInit {
  policies: any[] = [];

  constructor(
    private apiService: ApiService, 
    private authService: AuthService,
    private cdr: ChangeDetectorRef
  ) {}

  ngOnInit() {
    this.loadPolicies();
  }

  loadPolicies() {
    const superUserId = this.authService.getUserId();

    // Now calls /api/plans
    this.apiService.getSuperCreatedPolicies(superUserId).subscribe({
      next: (data: any) => {
        console.log('Fetched Plans:', data);
        this.policies = data;
        this.cdr.detectChanges(); 
      },
      error: (err: any) => {
        console.error('Failed to load plans:', err);
      }
    });
  }
}
-------------------

import { Component, OnInit, ChangeDetectorRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TableModule } from 'primeng/table';
import { Tag } from 'primeng/tag';
import { ApiService } from '../../../core/services/api';
import { AuthService } from '../../auth/auth.service';

@Component({
  selector: 'app-super-policies',
  standalone: true,
  imports: [CommonModule, TableModule, Tag],
  // Ensure this points to your HTML file if you are using one:
  templateUrl: './super-policies.component.html', 
  // OR keep the inline template if you prefer that structure
  styleUrl: './super-policies.component.scss' 
})
export class SuperPoliciesComponent implements OnInit {
  policies: any[] = [];

  constructor(
    private apiService: ApiService, 
    private authService: AuthService,
    private cdr: ChangeDetectorRef
  ) {}

  ngOnInit() {
    this.loadPolicies();
  }

  loadPolicies() {
    const superUserId = this.authService.getUserId();

    // Fetch from the corrected endpoint
    this.apiService.getSuperCreatedPolicies(superUserId).subscribe({
      next: (data: any) => {
        console.log('Final Policy Data for Table:', data); // Check this log!
        this.policies = data;
        this.cdr.detectChanges(); 
      },
      error: (err: any) => {
        console.error('Failed to load plans:', err);
      }
    });
  }
}
